name: build-and-deployment

on:
  push:
    branches: [develop]

jobs:
  # build and test jobs will be added later one we have unit tests in place
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: 'actions/checkout@v3'

    - id: 'auth'
      uses: 'google-github-actions/auth@v0'
      with:
        credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

    - id: 'deploy'
      uses: 'google-github-actions/deploy-cloud-functions@v0'
      with:
          name: rp-ivr-analytics-staging
          region: asia-south1
          description: 'Deploying staging function'
          memory_mb: 256
          timeout: 30
          runtime: python38
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          entry_point: webhook
          max_instances: 0 # Remove limitation
          env_vars: FLASK_ENV=${{ secrets.FLASK_ENV }},TESTING=${{ secrets.TESTING }},DEBUG=${{ secrets.DEBUG }},DB_USER=${{ secrets.DB_USER }},DB_PASSWORD=${{ secrets.DB_PASSWORD }},DB_NAME=${{ secrets.DB_NAME }},DB_PORT=${{ secrets.DB_PORT }},SECRET_KEY=${{ secrets.SECRET_KEY }},CONNECTION_NAME=${{ secrets.CONNECTION_NAME }},RETRY_LOGS_BATCH_LIMIT=1000,MAX_RETRY_ATTEMPTS_FOR_LOGS=3

    - name: Slack Notification
      uses: rtCamp/action-slack-notify@v2.0.2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      with:
        status: success
        message: 'Staging deployment completed successfully!'
        slack-token: ${{ secrets.SLACK_TOKEN }}
        slack-channel: ${{ secrets.SLACK_CHANNEL }}
